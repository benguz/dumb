<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dumb Trading</title>
    <link rel="icon" href="/icons/up/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/icons/up/favicon-16x16.png" sizes="16x16">
    <link rel="icon" href="/icons/up/favicon-32x32.png" sizes="32x32">
    <link rel="apple-touch-icon" href="/icons/up/apple-touch-icon.png">
    <link rel="android-chrome-icon" href="/icons/up/android-chrome-192x192.png" sizes="192x192">
    <link rel="android-chrome-icon" href="/icons/up/android-chrome-512x512.png" sizes="512x512">
    <meta name="description" content="Fake, funny stock trading platform for degenerates.">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: black;
            color: white;
            font-family: Arial, sans-serif;
        }
        
        .controls-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 0 auto;
            width: 95%;
            padding: 20px;
        }

        #stockSelect {
            padding: 10px;
            font-size: 16px;
            background-color: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 4px;
            width: 200px;
            max-height: fit-content;
        }
        
        #chartContainer {
            width: 95%;
            height: 80vh;
            margin: 0 auto;
            background-color: black;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px 0px;
            margin-bottom: 20px;
            position: relative;
        }

        .main-controls {
            display: flex;
            gap: 20px;
            width: 100%;
        }
        .trading-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        #currentPrice {
            font-size: 24px;
            font-weight: bold;
            text-align: right;
        }
        
        #stockChart {
            width: 100%;
            height: 100%;
        }


        .trading-button {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            font-weight: bold;
            transition: opacity 0.2s;
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        .trading-button:active {
            animation: buttonPress 0.1s ease;
        }

        .trading-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        #buyButton {
            background-color: #28a745;
            color: white;
        }

        #sellButton {
            background-color: #dc3545;
            color: white;
        }

        #leverageButton {
            background-color: #ffc107;
            color: black;
        }

        #portfolio {
            font-size: 18px;
            min-width: 200px;
        }

        #cashPosition {
            font-size: 18px;
            min-width: 150px;
        }

        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(220, 53, 69, 0.9);
            padding: 20px 40px;
            border-radius: 8px;
            font-size: 24px;
            font-weight: bold;
            z-index: 1000;
        }
        .credits {
            text-align: center; width: 95%; font-size: 10px; color: rgb(240, 240, 240); margin: 0 auto; margin-top: 40px;
        }
        @keyframes popupFade {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.7); }
            10% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            20% { transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        @keyframes textFlash {
            0% { color: black; }
            50% { color: white; }
            100% { color: black; }
        }

        @keyframes buttonPress {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.8);
    z-index: 1000;
}

.modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #222;
    padding: 20px;
    border-radius: 8px;
    width: 90%;
    max-width: 400px;
}

.slider-container {
    margin: 20px 0;
}

.slider-container label {
    display: block;
    margin-bottom: 10px;
    color: white;
}

input[type="range"] {
    width: 100%;
    background: #333;
    height: 8px;
    border-radius: 4px;
    -webkit-appearance: none;
}

input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    background: #ffc107;
    border-radius: 50%;
    cursor: pointer;
}

#optionsCountdown {
    position: absolute;
    top: 10px;
    left: 10px;
    color: #ffc107;
    font-size: 14px;
    z-index: 1;
}

#optionsProfit {
    position: absolute;
    top: 26px;
    left: 10px;
    color: white;
    font-size: 14px;
    z-index: 1;
}
.mobile-only {
    display: none;
}
        
        @media screen and (max-width: 768px) {
            .controls-row {
                flex-direction: column;
            }
            #chartContainer {
                width: 100%;
                height: 70vh;
                margin-left: 0;
                margin-right: 0;
            }
            #optionsCountdown {
                font-size: 16px;
            }
            #optionsProfit {
                top: 29px;
                font-size: 16px;
            }
            .main-controls {
                flex-direction: column;
            }
            .trading-controls {
                flex-direction: column;
                text-align: left;
                width: 100%;
                align-items: flex-start;
            }
            .controls-row {
                padding: 0;
                padding-top: 10px;
            }
            #currentPrice {
                position: absolute;
                top: 2px;
                right: 2px;
                z-index: 1000;
            }
            #stockSelect {
                width: max-content;
            }
            body {
                padding: 0;
            }
            .main {
                display: flex;
                flex-direction: column-reverse;
            }
            .trading-button {
                padding: 12px 24px;
            }
            .popup {
                padding: 10px 20px;
                font-size: 20px;
            }
            .desktop-only {
                display: none;
            }
            .mobile-only {
                display: block;
            }

            .modal-content {
                width: 85%;
                padding: 15px;
            }
            
            input[type="range"] {
                height: 6px;
            }
            
            input[type="range"]::-webkit-slider-thumb {
                width: 24px;
                height: 24px;
            }
            
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script defer data-domain="dumbtrading.com" src="https://plausible.io/js/script.js"></script>
</head>
<body>
    <div class="main">
    <div class="controls-row">
        <div class="main-controls" >
            <div style="display: flex; gap: 5px; width: 100%;">   
                <div>
                    <select id="stockSelect">
                        <option value="AAPL">Apple (AAPL)</option>
                        <option value="GOOGL">Google (GOOGL)</option>
                        <option value="TSLA">Tesla (TSLA)</option>
                        <option value="AMZN">Amazon (AMZN)</option>
                        <option value="BITCOIN">Bitcoin (BTC)</option>
                    </select>
                    <div class="mobile-only" style="margin-top: 5px;">
                        <button id="buyCallsButtonMobile" class="trading-button" style="display: none;">Buy Calls</button>
                        <button id="sellCallsButtonMobile" class="trading-button" style="display: none;">Sell Calls</button>
                    </div>
                </div>
                <div style="display: flex; direction: row; gap: 5px; width: 100%; flex-wrap: wrap;">
                    <button id="buyButton" class="trading-button">Buy</button>
                    <button id="sellButton" class="trading-button">Sell</button>
                    <button id="leverageButton" class="trading-button" style="display: none;">Leverage</button>
                    <p  id="leverageDisplay" style="font-size: 12px; color: white; margin: 0; padding: 0; display: none;">1x</p>
                </div>
            </div>
            
            <div class="trading-controls">
                <div id="portfolio">
                    Shares: 0 | P/L: $0.00
                </div>
                <div id="cashPosition">
                    Cash: $1,000.00
                </div>
            </div>
        </div>
        <div id="currentPrice"></div>
    </div>

    <div id="chartContainer">
        <canvas id="stockChart"></canvas>
    </div>
</div>
<div id="optionsModal" class="modal">
    <div class="modal-content">
        <h2>0DTE <span id="currentStock"></span> Options</h2>
        <div class="slider-container">
            <label>Investment: $<span id="investmentAmount">1000</span></label>
            <input type="range" id="investmentSlider" min="1" max="100" value="20">
        </div>
        <div class="slider-container">
            <label>Strike Price: $<span id="strikePrice">0</span></label>
            <input type="range" id="strikeSlider" min="80" max="120" value="100">
        </div>
        <div id="contractCount" style="text-align: left; width: 100%; padding-bottom: 10px; display: none;">
            <p>0 contracts (0 shares)</p>
        </div>
        <button id="confirmOptions" class="trading-button">Confirm</button>
        <div style="text-align: center; width: 100%; padding-top: 10px;">
            <p style="color: red;">warning: options are for degenerates only</p>
        </div>
    </div>
</div>
    
<div class="controls-row desktop-only" style="padding-top: 0;" >
    <button id="shareButton" class="trading-button" onclick="shareScreenshot('portfolio')">🤳 Share Portfolio Screenshot</button>
    <button id="buyCallsButton" class="trading-button" style="display: none;">Buy Calls</button>
    <button id="sellCallsButton" class="trading-button" style="display: none;">Sell Calls</button>
</div>
  
    <div class="credits">
        <button id="shareButtonMobile" style="margin-bottom: 10px;" class="trading-button mobile-only" onclick="shareScreenshot('portfolio')">🤳 Share Portfolio</button>

        inspired by <a href="https://neal.fun" target="_blank" style="color: rgb(240, 240, 240);">neal.fun</a>, made with ❤️ by <a href="https://benguzovsky.com" target="_blank" style="color: rgb(240, 240, 240);">ben</a>
    </div>

    <script>
        // Generate random starting prices between 100 and 1000
        const APPLPRICE = Math.random() * 100 + 100;
        const GOOGLPRICE = Math.random() * 500 + 100;
        const TSLAPRICE = Math.random() * 350 + 100;
        const AMZNPRICE = Math.random() * 250 + 100;
        const BITCOINPRICE = Math.random() * 10000 + 10000;
        const stockData = {
            AAPL: {currentPrice: APPLPRICE, history: [], startPrice: APPLPRICE, shares: 0, totalCost: 0},
            GOOGL: {currentPrice: GOOGLPRICE, history: [], startPrice: GOOGLPRICE, shares: 0, totalCost: 0},
            TSLA: {currentPrice: TSLAPRICE, history: [], startPrice: TSLAPRICE, shares: 0, totalCost: 0},
            AMZN: {currentPrice: AMZNPRICE, history: [], startPrice: AMZNPRICE, shares: 0, totalCost: 0},
            BITCOIN: {currentPrice: BITCOINPRICE, history: [], startPrice: BITCOINPRICE, shares: 0, totalCost: 0}
        };
        function createGradient(ctx, isPositive) {
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            if (isPositive) {
                gradient.addColorStop(0, 'rgba(0, 255, 0, 0.7)');
                gradient.addColorStop(1, 'rgba(0, 255, 0, 0.0)');
            } else {
                gradient.addColorStop(0, 'rgba(255, 0, 0, 0.7)');
                gradient.addColorStop(1, 'rgba(255, 0, 0, 0.0)');
            }
            return gradient;
        }

        let cashBalance = localStorage.getItem('cashBalance') ? Math.max(1000, parseInt(localStorage.getItem('cashBalance'))) : 1000; // Starting cash position
        let accountHistory = [cashBalance];
        let leverage = 1;
        // get this info from local storage
        let leverageUnlocked = localStorage.getItem('leverageUnlocked') ? localStorage.getItem('leverageUnlocked') === 'true' : false;
        if (leverageUnlocked) {
            document.getElementById('leverageButton').style.display = 'inline-block';
            document.getElementById('leverageDisplay').style.display = 'inline-block';
        }
        let optionsUnlocked = localStorage.getItem('optionsUnlocked') ? localStorage.getItem('optionsUnlocked') === 'true' : false;
        if (optionsUnlocked) {
            if (window.innerWidth < 768) {
                document.getElementById('buyCallsButtonMobile').style.display = 'inline-block';
                document.getElementById('buyCallsButtonMobile').addEventListener('click', showOptionsModal);
            } else {
                document.getElementById('buyCallsButton').style.display = 'inline-block';
                document.getElementById('buyCallsButton').addEventListener('click', showOptionsModal);
            }
            // add event listener to buyCallsButton
        }
        let marginCallCount = parseInt(localStorage.getItem('marginCallCount')) || 0;
        let difficultyLevel = parseInt(localStorage.getItem('difficultyLevel')) || 1;
        let milestones = localStorage.getItem('milestones') ? JSON.parse(localStorage.getItem('milestones')) : {
            100000: {reached: false, string: "100K"},
            1000000: {reached: false, string: "1M"},
            10000000: {reached: false, string: "10M"},
            100000000: {reached: false, string: "100M"},
            1000000000: {reached: false, string: "1B"},
            10000000000: {reached: false, string: "10B"},
            100000000000: {reached: false, string: "100B"},
            1000000000000: {reached: false, string: "1T"},
        };
        let shamelessPlug = localStorage.getItem('shamelessPlug') ? localStorage.getItem('shamelessPlug') === 'true' : false;
        // Initialize history arrays
        Object.keys(stockData).forEach(stock => {
            const data = stockData[stock];
            data.startPrice = data.currentPrice;
            
            // initialize random up and down moves around the start price
            data.history = Array(50).fill(0).map((_, i) => {
                return data.startPrice * (Math.random() < 0.5 ? 1 + (Math.random() * 0.001) : 1 - (Math.random() * 0.001));
            });
        });

        let chart;
        let currentStock = 'AAPL';

        function checkForMarginCall() {
            if (cashBalance < 0) {
                showMarginCallPopup();
                marginCallCount++; 
                localStorage.setItem('marginCallCount', marginCallCount);
                cashBalance = 1000;
                updateCashPosition();
            }
        }

        function checkForOptionsUnlock() {
            if (!optionsUnlocked && cashBalance >= 50000) {
                optionsUnlocked = true;
                localStorage.setItem('optionsUnlocked', 'true');
                if (window.innerWidth < 768) {
                    document.getElementById('buyCallsButtonMobile').style.display = 'inline-block';
                    document.getElementById('buyCallsButtonMobile').addEventListener('click', showOptionsModal);
                } else {
                    document.getElementById('buyCallsButton').style.display = 'inline-block';
                    document.getElementById('buyCallsButton').addEventListener('click', showOptionsModal);
                }
            }
        }

        let optionsActive = false;
        let optionsStrikePrice = 0;
        let optionsInvestment = 0;
        let optionsTimeRemaining = 0;
        let optionsInterval;
        let trueShareCount = 0;

        function showOptionsModal() {
            const modal = document.getElementById('optionsModal');
            const data = stockData[currentStock];
            const currentPrice = data.currentPrice;
            
            // Update strike slider based on current price
            const strikeSlider = document.getElementById('strikeSlider');
            strikeSlider.min = Math.floor(currentPrice * 0.8);
            strikeSlider.max = Math.ceil(currentPrice * 1.2);
            strikeSlider.value = Math.floor(currentPrice);
            
            // Update investment slider based on cash balance
            const investmentSlider = document.getElementById('investmentSlider');
            investmentSlider.max = cashBalance;
            investmentSlider.value = Math.min(cashBalance * 0.2, 100000);

            document.getElementById('currentStock').textContent = currentStock;
            
            updateSliderDisplays();
            modal.style.display = 'block';
        }


        function updateSliderDisplays() {
            document.getElementById('strikePrice').textContent = 
                parseFloat(document.getElementById('strikeSlider').value).toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            
            document.getElementById('investmentAmount').textContent = 
                parseFloat(document.getElementById('investmentSlider').value).toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            
            const strikePrice = parseFloat(document.getElementById('strikeSlider').value);
            const currentPrice = stockData[currentStock].currentPrice;
            const investment = parseFloat(document.getElementById('investmentSlider').value);
            
            // Calculate time value (using fixed time of 10000 ticks)
            const timeValue = 0.2; // 20% time premium
                        
            // Add volatility premium (higher for OTM options)
            const volatilityPremium = strikePrice > currentPrice ? 0.5 : 0.25; 
            
            // Calculate total premium percentage
            const premiumPercent = (timeValue + volatilityPremium);
            
            // For call options:
            const intrinsicValue = currentPrice > strikePrice ? Math.max(0.001, currentPrice - strikePrice) / currentPrice : Math.abs(currentPrice - strikePrice) / currentPrice;
            const timeAndVolValue = strikePrice * premiumPercent;
            const contractCost = (intrinsicValue + timeAndVolValue) * 100;
            
            // Calculate number of contracts investment can buy
            const numContracts = investment / contractCost;
            
            // Display number of contracts
            document.getElementById('contractCount').textContent = 
                `${numContracts.toFixed(2)} contract${numContracts !== 1 ? 's' : ''} (${(numContracts * 100).toFixed(2)} shares)`;
            trueShareCount = numContracts * 100;
        }

        document.getElementById('strikeSlider').addEventListener('input', updateSliderDisplays);
        document.getElementById('investmentSlider').addEventListener('input', updateSliderDisplays);

        document.getElementById('confirmOptions').addEventListener('click', () => {
            optionsStrikePrice = parseFloat(document.getElementById('strikeSlider').value);
            optionsInvestment = parseFloat(document.getElementById('investmentSlider').value);
            cashBalance -= optionsInvestment;
            optionsActive = true;
            optionsTimeRemaining = Math.max(500 - (50 * (difficultyLevel - 1)), 100);
            
            document.getElementById('optionsModal').style.display = 'none';
            // hide the buy calls button
            document.getElementById('buyCallsButton').style.display = 'none';
            document.getElementById('buyCallsButtonMobile').style.display = 'none';
            // show the sell calls button
            if (window.innerWidth < 768) {
                document.getElementById('sellCallsButtonMobile').style.display = 'inline-block';
            } else {
                document.getElementById('sellCallsButton').style.display = 'inline-block';
            }
            
            // Add countdown display to chart container
            const countdownDiv = document.createElement('div');
            countdownDiv.id = 'optionsCountdown';
            document.getElementById('chartContainer').appendChild(countdownDiv);

            const optionsProfit = document.createElement('div');
            optionsProfit.id = 'optionsProfit';
            document.getElementById('chartContainer').appendChild(optionsProfit);
            
            updateChart(currentStock);
            updateCashPosition();
        });

                
        function clearOptionsState() {
            optionsActive = false;
            optionsStrikePrice = 0;
            optionsTimeRemaining = 0;
            trueShareCount = 0;
            const countdown = document.getElementById('optionsCountdown');
            if (countdown) countdown.remove();
            const optionsProfit = document.getElementById('optionsProfit');
            if (optionsProfit) optionsProfit.remove();
            clearInterval(optionsInterval);
            // show the buy calls button
            // hide the sell calls button
            if (window.innerWidth < 768) {
                document.getElementById('sellCallsButtonMobile').style.display = 'none';
                document.getElementById('buyCallsButtonMobile').style.display = 'inline-block';
            } else {
                document.getElementById('sellCallsButton').style.display = 'none';
                document.getElementById('buyCallsButton').style.display = 'inline-block';
            }

        }


        function showOptionsUnlockPopup() {
            const popup = document.createElement('div');
            popup.innerHTML = '$$$$$$$ VOLATILITY INCREASED';
            popup.classList.add('popup');
            popup.style.cssText = `
                color: white;
                text-align: center;
                animation: popupFade 3s forwards, textFlash 0.5s linear infinite;
            `;

            document.body.appendChild(popup);

            setTimeout(() => {
                popup.remove();
            }, 3000);
        }

        function showMarginCallPopup() {
            const popup = document.createElement('div');
            popup.innerHTML = 'MARGIN CALL IN PROGRESS<br>SELLING 20% OF YOUR SOUL';
            popup.classList.add('popup');
            popup.style.cssText = `
                background-color: rgba(220, 53, 69, 0.9);
                color: white;
                text-align: center;
                animation: popupFade 3s forwards, textFlash 0.5s linear infinite;
            `;

            document.body.appendChild(popup);

            setTimeout(() => {
                popup.remove();
            }, 3000);
        }


        function updateButtonStates() {
            const buyButton = document.getElementById('buyButton');
            const sellButton = document.getElementById('sellButton');
            const data = stockData[currentStock];
            
            buyButton.disabled = cashBalance < data.currentPrice;
            sellButton.disabled = data.shares <= 0;
        }

        function updateCashPosition() {
            const cashDisplay = document.getElementById('cashPosition');
            cashDisplay.textContent = `Cash: $${cashBalance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            // cashDisplay.style.color = cashBalance >= 1000 ? '#00ff00' : '#ffffff';
            checkForOptionsUnlock();
            updateButtonStates();
            localStorage.setItem('cashBalance', cashBalance);
        }

        function updatePortfolio() {
            const data = stockData[currentStock];
            const shares = data.shares;
            const currentValue = shares * data.currentPrice;
            const profitLoss = (currentValue - data.totalCost) * leverage;
            const portfolio = document.getElementById('portfolio');
            portfolio.textContent = `Shares: ${shares} | P/L: ${profitLoss >= 0 ? '+' : ''}$${profitLoss.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            portfolio.style.color = profitLoss >= 0 ? '#00ff00' : '#ff0000';
            updateButtonStates();
            accountHistory.push(profitLoss + cashBalance);
        }

        function showMilestonePopup(milestone, reporting) {
            const popup = document.createElement('div');
            popup.innerHTML = `${milestone} RETURN - ${!reporting ? 'FLEX ON THE GROUPCHAT?' : 'DIFFICULTY INCREASED'}`;
            popup.classList.add('popup');
            popup.style.cssText = `
                background-color: rgba(255, 193, 7, 0.9);
                color: black;
                text-align: center;
                animation: popupFade 3s forwards, textFlash 0.5s linear infinite;
            `;
            document.body.appendChild(popup);
            setTimeout(() => {
                popup.remove();
            }, 3000);
        }

        function updatePrice(stock) {
            const data = stockData[stock];

            // Randomly trigger special events
            const eventLikelihood = stock === "TSLA" ? 0.03 : stock === "AMZN" ? 0.01 : 0.005
            let eventDirection = optionsUnlocked ? 0.6 : 0.5
            if (data.currentPrice < 5) {
                eventDirection = 0.2;
            }
            if (Math.random() < eventLikelihood) {
                data.eventType = Math.random() < eventDirection ? 'crash' : 'boom';
                data.eventDuration = Math.floor(Math.random() * 20) + 10; // 10-30 ticks
                data.eventStrength = (Math.random() * 0.5) + 0.5; // 0.5-1.0 strength
            }

            let baseVolatility = stock === 'BITCOIN' ? 0.13 : 0.04;
            if (optionsUnlocked) {
                baseVolatility += 0.02;
            }

            if (!data.momentum) data.momentum = 0;
            data.momentum *= 0.95; // Decay previous momentum
            data.momentum += (Math.random() - 0.5) * 0.1; // Add new momentum
            data.momentum = Math.max(Math.min(data.momentum, 1), -1); // Clamp momentum
                

            let changePercent = (Math.random() - 0.5 + data.momentum) * baseVolatility;
            if (data.eventType && data.eventDuration > 0) {
                if (data.eventType === 'crash') {
                    changePercent -= data.eventStrength * 0.1;
                } else { // boom
                    changePercent += data.eventStrength * 0.1;
                }
                data.eventDuration--;
                if (data.eventDuration <= 0) {
                    data.eventType = null;
                }
            }
            
            const meanReversionFactor = stock === 'AAPL' ? 0.05 : stock === "GOOGL" ? 0.01 : stock === "BITCOIN" ? 0.001 : 0; // Adjust this factor to control mean reversion strength
            const meanPrice = data.startPrice;
            let newPrice;
            if (stock === 'TSLA' || stock === 'AMZN') {
                const distanceFromMean = (meanPrice - data.currentPrice) / meanPrice;
                const meanReversionChange = distanceFromMean * meanReversionFactor;
                newPrice = data.currentPrice * (1 + changePercent + meanReversionChange);
            } else {
                newPrice = data.currentPrice * (1 + changePercent) + meanReversionFactor * (meanPrice - data.currentPrice);
            }
            data.currentPrice = Math.max(newPrice, 1);

            
            stockData[stock].history.push(newPrice);
            if (stockData[stock].history.length > 50) {
                stockData[stock].history.shift();
            }

            // Update price display
            const priceDisplay = document.getElementById('currentPrice');
            const isPositive = newPrice >= stockData[stock].startPrice;
            priceDisplay.style.color = isPositive ? '#00ff00' : '#ff0000';
            priceDisplay.textContent = `$${newPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            // change favicon in head from icons/up/favicon.ico to icons/down/favicon.ico
            const favicons = document.querySelectorAll('link[rel="icon"]');
            const appleIcon = document.querySelector('link[rel="apple-touch-icon"]');
            const androidIcons = document.querySelectorAll('link[rel="android-chrome-icon"]');
            
            const direction = isPositive ? 'up' : 'down';
            favicons.forEach(icon => {
                const currentPath = icon.getAttribute('href');
                icon.href = currentPath.replace(/\/(up|down)\//, `/${direction}/`);
            });
            
            appleIcon.href = `/icons/${direction}/apple-touch-icon.png`;
            
            androidIcons.forEach(icon => {
                const currentPath = icon.getAttribute('href');
                icon.href = currentPath.replace(/\/(up|down)\//, `/${direction}/`);
            });
            
            updatePortfolio();
        }

        function updateChart(stock) {
            const ctx = document.getElementById('stockChart').getContext('2d');
            const data = stockData[stock];
            const isPositive = data.history[data.history.length - 1] >= data.history[0];

            if (!chart) {
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array(data.history.length).fill(''),
                        datasets: [{
                            label: stock,
                            data: data.history,
                            borderColor: isPositive ? '#00ff00' : '#ff0000',
                            borderWidth: 2,
                            fill: isPositive ? true : 'origin',
                            backgroundColor: createGradient(ctx, isPositive),
                            tension: 0.4,
                            pointRadius: 0 
                        },
                        {
                            label: 'Starting Price',
                            data: Array(data.history.length).fill(data.startPrice),
                            borderColor: '#666',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: {
                                    color: '#333'
                                },
                                ticks: {
                                    display: false
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        animation: {
                            duration: 0,
                        }
                    }
                });
            } else {
                chart.data.datasets[0].data = data.history;
                chart.data.datasets[0].borderColor = isPositive ? '#00ff00' : '#ff0000';
                chart.data.datasets[0].fill = isPositive ? true : 'origin';
                chart.data.datasets[0].backgroundColor = createGradient(ctx, isPositive);
                chart.data.datasets[1].data = Array(data.history.length).fill(data.startPrice);
                if (optionsActive && chart.data.datasets.length < 3) {
                    chart.data.datasets.push({
                        label: 'Strike Price',
                        data: Array(data.history.length).fill(optionsStrikePrice),
                        borderColor: '#ffc107',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0,
                        pointRadius: 0
                    });
                }
                if (chart.data.datasets.length > 2 && !optionsActive) {
                    chart.data.datasets.pop();
                }
                if (optionsActive) {
                    document.getElementById('optionsCountdown').textContent = 
                        `Option expires in ${optionsTimeRemaining} ticks`;
                    
                    const finalPrice = data.currentPrice;
                    const profit = callProfit(finalPrice, trueShareCount, optionsStrikePrice, optionsInvestment);

                    document.getElementById('optionsProfit').textContent = 
                        `Options P/L: $${(profit - optionsInvestment).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    if (optionsTimeRemaining <= 0) {
                        cashBalance += profit;
                        clearOptionsState();
                        updateCashPosition();
                    }
                    
                    optionsTimeRemaining--;
                }
                const recentHistory = data.history.slice(-50);
                // if bitcoin, set a larger multiplier on that startPrice
                const multiplier = stock === 'BITCOIN' ? 0.1 : 0.03;
                chart.options.scales.y.min = Math.min(...recentHistory, data.startPrice * (1 - multiplier));
                chart.options.scales.y.max = Math.max(...recentHistory, data.startPrice * (1 + multiplier));
                chart.update();
            }
        }

        document.getElementById('stockSelect').addEventListener('change', (e) => {
            currentStock = e.target.value;
            if (chart) {
                chart.destroy();
                chart = null;
            }
            updateChart(currentStock);
            updatePortfolio();
        });

        document.getElementById('buyButton').addEventListener('click', () => {
            const data = stockData[currentStock];
            if (cashBalance >= data.currentPrice) {
                data.shares++;
                data.totalCost += data.currentPrice;
                cashBalance -= data.currentPrice;
                updatePortfolio();
                updateCashPosition();
            }
        });

        document.getElementById('sellButton').addEventListener('click', () => {
            const data = stockData[currentStock];
            if (data.shares > 0) {
                if (!leverageUnlocked) {
                    leverageUnlocked = true;
                    localStorage.setItem('leverageUnlocked', 'true');
                    document.getElementById('leverageButton').style.display = 'inline-block';
                    document.getElementById('leverageDisplay').style.display = 'inline-block';
                    showLeveragePopup();
                }
                data.shares--;
                const sellValue = data.currentPrice + ((data.currentPrice - (data.totalCost / (data.shares + 1))) * (leverage - 1));
                cashBalance += sellValue;
                data.totalCost = (data.shares * data.totalCost) / (data.shares + 1); // Adjust cost basis
                updatePortfolio();
                updateCashPosition();
                checkForMarginCall();
                let justReached = false
                for (let milestone in milestones) {
                    if (!milestones[milestone].reached && cashBalance >= milestone) {
                        milestones[milestone].reached = true;
                        if (!justReached) {
                            justReached = true;
                            console.log("shamelessPlug", shamelessPlug);
                            showMilestonePopup(milestones[milestone].string, shamelessPlug);
                            localStorage.setItem('milestones', JSON.stringify(milestones));
                            if (!shamelessPlug) {
                                setTimeout(() => {
                                    shareScreenshot("text");
                                }, 1700); 
                                shamelessPlug = true;
                                localStorage.setItem('shamelessPlug', 'true');
                            } else {
                                difficultyLevel++;
                                localStorage.setItem('difficultyLevel', difficultyLevel);
                            }
                        }
                    }
                }
            }
        });

        function callProfit(price, shares, strike, investment, leverage=1) {
            const priceDiff = Math.max(0, price - strike);
            return priceDiff * shares * leverage
        }

        document.getElementById('sellCallsButton').addEventListener('click', () => {
            const data = stockData[currentStock];
            const currentPrice = data.currentPrice;
            // investment has already been subtracted from cashBalance
            cashBalance += callProfit(currentPrice, trueShareCount, optionsStrikePrice, optionsInvestment);
            clearOptionsState();
            updateCashPosition();
        });
        document.getElementById('sellCallsButtonMobile').addEventListener('click', () => {
            const data = stockData[currentStock];
            const currentPrice = data.currentPrice;
            // investment has already been subtracted from cashBalance
            cashBalance += callProfit(currentPrice, trueShareCount, optionsStrikePrice, optionsInvestment);
            clearOptionsState();
            updateCashPosition();
        });

        document.getElementById('leverageButton').addEventListener('click', () => {
            leverage = leverage === 8 ? 1 : leverage * 2;
            document.getElementById('leverageDisplay').textContent = leverage + 'x';
            updatePortfolio();
        });
        // Add this new function
        function showLeveragePopup() {
            // const sound = new Audio('/sounds/leverage.wav');
            // sound.volume = 0.5; // Adjust volume to 50%
            // sound.play().catch(e => console.log('Sound play failed:', e)); // Catch errors if sound fails to play

            const popup = document.createElement('div');
            popup.innerHTML = 'LEVERAGE ENABLED';
            popup.classList.add('popup');
            popup.style.cssText = `
                background-color: rgba(255, 193, 7, 0.9);
                color: black;
                text-align: center;
                animation: popupFade 2s forwards, textFlash 0.5s linear infinite;
                z-index: 1000;
            `;

            // Add the animation style to head
            const style = document.createElement('style');
            style.textContent = `
                @keyframes popupFade {
                    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.7); }
                    10% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
                    20% { transform: translate(-50%, -50%) scale(1); }
                    80% { opacity: 1; }
                    100% { opacity: 0; }
                }
                @keyframes textFlash {
                    0% { color: black; }
                    50% { color: white; }
                    100% { color: black; }
                }

                @media screen and (max-width: 768px) {
                    .popup {
                        font-size: 18px;
                        padding: 15px 30px;
                    }
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(popup);

            // Remove popup after animation
            setTimeout(() => {
                popup.remove();
                style.remove();
            }, 2000);
        }

        // Update prices and chart every 100ms for smoother animation
        setInterval(() => {
            updatePrice(currentStock);
            updateChart(currentStock);
        }, 100);

        // Initial setup
        updateChart('AAPL');
        updateCashPosition();
        updateButtonStates();

        function shareScreenshot(text) {
            const canvas = document.createElement('canvas');
            if (!navigator.share) {
                return;
            }

            // Set canvas dimensions for phone-like aspect ratio
            canvas.width = 1080;
            canvas.height = 1920;
            const ctx = canvas.getContext('2d');

            // Colors
            const isPositive = accountHistory[accountHistory.length-1] >= accountHistory[0];
            const graphColor = isPositive ? '#00C805' : '#FF5000'; // Robinhood green/red
            const bgColor = '#000000';
            const textColor = '#FFFFFF';
            const subTextColor = '#8E8E93';

            // Fill background
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Add "Investing" header with down carat
            ctx.fillStyle = textColor;
            ctx.font = '72px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
            ctx.fillText('Investing', 60, 120);
            
            // Add current balance
            ctx.font = '72px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
            const currentBalance = accountHistory[accountHistory.length-1];
            ctx.fillText(`$${currentBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 60, 210);

            // Add total gain/loss
            const startValue = accountHistory[0];
            const totalChange = currentBalance - startValue;
            const percentChange = ((totalChange / startValue) * 100).toFixed(2);
            ctx.fillStyle = graphColor;
            ctx.font = '40px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
            ctx.fillText(`${isPositive ? '+' : ''}$${totalChange.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${isPositive ? '+' : ''}${percentChange}%)`, 60, 290);

            // Calculate scaling for graph
            let padding = {top: 400, bottom: 500, left: 0, right: 0};
            const graphHeight = canvas.height - padding.top - padding.bottom;
            const graphWidth = canvas.width - padding.left - padding.right;
            const minValue = Math.min(...accountHistory);
            const maxValue = Math.max(...accountHistory);
            const valueRange = maxValue - minValue;

            // Draw graph
            ctx.strokeStyle = graphColor;
            ctx.lineWidth = 4;
            ctx.beginPath();
            for (let i = 0; i < accountHistory.length; i++) {
                const x = padding.left + (graphWidth / (accountHistory.length - 1)) * i;
                const y = padding.top + ((maxValue - accountHistory[i]) / valueRange) * graphHeight;
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();

            // Add gradient fill under graph
            const gradient = ctx.createLinearGradient(0, padding.top, 0, padding.top + graphHeight);
            gradient.addColorStop(0, isPositive ? 'rgba(0, 200, 5, 0.2)' : 'rgba(255, 80, 0, 0.2)');
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
            
            ctx.fillStyle = gradient;
            ctx.lineTo(padding.left + graphWidth, padding.top + graphHeight);
            ctx.lineTo(padding.left, padding.top + graphHeight);
            ctx.closePath();
            ctx.fill();

            // Add time period buttons
            const periods = ['1D', '1W', '1M', '3M', 'YTD', '1Y', 'ALL'];
            ctx.font = '40px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
            const buttonHeight = 60;
            const buttonWidth = 100;
            const periodWidth = (graphWidth - 120) / (periods.length - 1);
            
            periods.forEach((period, i) => {
                const x = 60 + periodWidth * i - buttonWidth/2;
                const y = canvas.height - 320 - buttonHeight/2;
                
                if (period === 'ALL') {
                    // Draw red background for ALL button
                    ctx.fillStyle = isPositive ? '#00C805' : '#FF5000'; // Robinhood green/red

                    ctx.beginPath();
                    ctx.roundRect(x, y, buttonWidth, buttonHeight, 15);
                    ctx.fill();
                    
                    // Draw black text for ALL
                    ctx.fillStyle = '#000000';
                } else {
                    // Draw red text for other periods
                    ctx.fillStyle = isPositive ? '#00C805' : '#FF5000'; // Robinhood green/red
                }
                
                ctx.textAlign = 'center';
                ctx.fillText(period, x + buttonWidth/2, y + buttonHeight/1.3);
                ctx.textAlign = 'left';
            });
            // Add thin gray line above buying power
            ctx.strokeStyle = '#333333';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(60, canvas.height - 250);
            ctx.lineTo(canvas.width - 60, canvas.height - 250);
            ctx.stroke();

            // Add "Buying Power" section
            ctx.fillStyle = textColor;
            ctx.font = '40px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
            ctx.fillText(`Buying Power `, 60, canvas.height - 190);
            ctx.textAlign = 'right';
            ctx.fillText(`$${cashBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, canvas.width - 60, canvas.height - 190);

            ctx.font = '40px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
            ctx.fillText('dumbtrading.com', canvas.width - 60, canvas.height - 50);

            // Share the screenshot
            canvas.toBlob(async (blob) => {
                const file = new File([blob], 'portfolio.png', { type: 'image/png' });
                try {
                    await navigator.share({
                        title: isPositive ? 'Massive Day on the Market' : 'L',
                        text: isPositive ? 'See you in the rearview mirror of my lambo' : 'fuck.',
                        files: [file]
                    });
                } catch (err) {
                    console.error('Error sharing:', err);
                }
            });
        }
    </script>
</body>
</html>
