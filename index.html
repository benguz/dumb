<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dumb Trading</title>
    <link rel="icon" href="/icons/up/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/icons/up/favicon-16x16.png" sizes="16x16">
    <link rel="icon" href="/icons/up/favicon-32x32.png" sizes="32x32">
    <link rel="apple-touch-icon" href="/icons/up/apple-touch-icon.png">
    <link rel="android-chrome-icon" href="/icons/up/android-chrome-192x192.png" sizes="192x192">
    <link rel="android-chrome-icon" href="/icons/up/android-chrome-512x512.png" sizes="512x512">
    <meta name="description" content="Fake, funny stock trading platform for degenerates.">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: black;
            color: white;
            font-family: Arial, sans-serif;
        }
        
        .controls-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 0 auto;
            width: 95%;
            padding: 20px;
        }

        
        
        #stockSelect {
            padding: 10px;
            font-size: 16px;
            background-color: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 4px;
            width: 200px;
            max-height: fit-content;
        }
        
        #chartContainer {
            width: 95%;
            height: 80vh;
            margin: 0 auto;
            background-color: black;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px 0px;
            margin-bottom: 20px;
            position: relative;
        }

        .main-controls {
            display: flex;
            gap: 20px;
            width: 100%;
        }
        .trading-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        #currentPrice {
            font-size: 24px;
            font-weight: bold;
            text-align: right;
        }
        
        #stockChart {
            width: 100%;
            height: 100%;
        }


        .trading-button {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            font-weight: bold;
            transition: opacity 0.2s;
        }
        .trading-button:active {
            animation: buttonPress 0.1s ease;
        }

        .trading-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        #buyButton {
            background-color: #28a745;
            color: white;
        }

        #sellButton {
            background-color: #dc3545;
            color: white;
        }

        #leverageButton {
            background-color: #ffc107;
            color: black;
        }

        #portfolio {
            font-size: 18px;
            min-width: 200px;
        }

        #cashPosition {
            font-size: 18px;
            min-width: 150px;
        }
        @keyframes popupFade {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.7); }
            10% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            20% { transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        @keyframes textFlash {
            0% { color: black; }
            50% { color: white; }
            100% { color: black; }
        }

        @keyframes buttonPress {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        
        @media screen and (max-width: 768px) {
            .controls-row {
                flex-direction: column;
            }
            #chartContainer {
                width: 100%;
                height: 70vh;
                margin-left: 0;
                margin-right: 0;
            }
            .main-controls {
                flex-direction: column;
            }
            .trading-controls {
                flex-direction: column;
                text-align: left;
                width: 100%;
                align-items: flex-start;
            }
            .controls-row {
                padding: 0;
                padding-top: 10px;
            }
            #currentPrice {
                position: absolute;
                top: 2px;
                right: 2px;
                z-index: 1000;
            }
            body {
                padding: 0;
                display: flex;
                flex-direction: column-reverse;
            }
            .trading-button {
                padding: 12px 24px;
            }
            
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script defer data-domain="dumbtrading.com" src="https://plausible.io/js/script.js"></script>
</head>
<body>
    <div class="controls-row">
        <div class="main-controls" >
            <div style="display: flex; gap: 5px; width: 100%;">   
            <select id="stockSelect">
                <option value="AAPL">Apple (AAPL)</option>
                <option value="GOOGL">Google (GOOGL)</option>
                <option value="MSFT">Microsoft (MSFT)</option>
                <option value="AMZN">Amazon (AMZN)</option>
                <option value="BITCOIN">Bitcoin (BTC)</option>
            </select>
            <div style="display: flex; direction: row; gap: 5px; width: 100%; flex-wrap: wrap;">
                <button id="buyButton" class="trading-button">Buy</button>
                <button id="sellButton" class="trading-button">Sell</button>
                <button id="leverageButton" class="trading-button" style="display: none;">Leverage</button>
                <p  id="leverageDisplay" style="font-size: 12px; color: white; margin: 0; padding: 0; display: none;">1x</p>
        </div>
        </div>
            
            <div class="trading-controls">
                <div id="portfolio">
                    Shares: 0 | P/L: $0.00
                </div>
                <div id="cashPosition">
                    Cash: $1,000.00
                </div>
            </div>
        </div>
        <div id="currentPrice"></div>
    </div>

    <div id="chartContainer">
        <canvas id="stockChart"></canvas>
    </div>

    <script>
        // Generate random starting prices between 100 and 1000
        const APPLPRICE = Math.random() * 100 + 100;
        const GOOGLPRICE = Math.random() * 500 + 100;
        const TSLAPRICE = Math.random() * 350 + 100;
        const AMZNPRICE = Math.random() * 250 + 100;
        const BITCOINPRICE = Math.random() * 10000 + 10000;
        const stockData = {
            AAPL: {currentPrice: APPLPRICE, history: [], startPrice: APPLPRICE, shares: 0, totalCost: 0},
            GOOGL: {currentPrice: GOOGLPRICE, history: [], startPrice: GOOGLPRICE, shares: 0, totalCost: 0},
            TSLA: {currentPrice: TSLAPRICE, history: [], startPrice: TSLAPRICE, shares: 0, totalCost: 0},
            AMZN: {currentPrice: AMZNPRICE, history: [], startPrice: AMZNPRICE, shares: 0, totalCost: 0},
            BITCOIN: {currentPrice: BITCOINPRICE, history: [], startPrice: BITCOINPRICE, shares: 0, totalCost: 0}
        };
        function createGradient(ctx, isPositive) {
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            if (isPositive) {
                gradient.addColorStop(0, 'rgba(0, 255, 0, 0.7)');
                gradient.addColorStop(1, 'rgba(0, 255, 0, 0.0)');
            } else {
                gradient.addColorStop(0, 'rgba(255, 0, 0, 0.7)');
                gradient.addColorStop(1, 'rgba(255, 0, 0, 0.0)');
            }
            return gradient;
        }


        let cashBalance = 1000; // Starting cash position
        let leverage = 1;
        let leverageUnlocked = false;

        // Initialize history arrays
        Object.keys(stockData).forEach(stock => {
            stockData[stock].startPrice = stockData[stock].currentPrice;
            stockData[stock].history = Array(50).fill(stockData[stock].currentPrice );
        });

        let chart;
        let currentStock = 'AAPL';

        function checkForMarginCall() {
            if (cashBalance < 0) {
                showMarginCallPopup();
                cashBalance = 1000;
                updateCashPosition();
            }
        }

        function showMarginCallPopup() {
            const popup = document.createElement('div');
            popup.innerHTML = 'MARGIN CALL IN PROGRESS<br>SELLING 20% OF YOUR SOUL';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: rgba(220, 53, 69, 0.9);
                color: white;
                padding: 20px 40px;
                border-radius: 8px;
                font-size: 24px;
                font-weight: bold;
                text-align: center;
                animation: popupFade 3s forwards, textFlash 0.5s linear infinite;
                z-index: 1000;
            `;

            document.body.appendChild(popup);

            setTimeout(() => {
                popup.remove();
            }, 3000);
        }


        function updateButtonStates() {
            const buyButton = document.getElementById('buyButton');
            const sellButton = document.getElementById('sellButton');
            const data = stockData[currentStock];
            
            buyButton.disabled = cashBalance < data.currentPrice;
            sellButton.disabled = data.shares <= 0;
        }

        function updateCashPosition() {
            const cashDisplay = document.getElementById('cashPosition');
            cashDisplay.textContent = `Cash: $${cashBalance.toFixed(2)}`;
            // cashDisplay.style.color = cashBalance >= 1000 ? '#00ff00' : '#ffffff';
            updateButtonStates();
        }

        function updatePortfolio() {
            const data = stockData[currentStock];
            const shares = data.shares;
            const currentValue = shares * data.currentPrice;
            const profitLoss = (currentValue - data.totalCost) * leverage;
            const portfolio = document.getElementById('portfolio');
            portfolio.textContent = `Shares: ${shares} | P/L: ${profitLoss >= 0 ? '+' : ''}$${profitLoss.toFixed(2)}`;
            portfolio.style.color = profitLoss >= 0 ? '#00ff00' : '#ff0000';
            updateButtonStates();
        }

        function updatePrice(stock) {
            const data = stockData[stock];

            // Randomly trigger special events
            const eventLikelihood = stock === "TSLA" ? 0.03 : stock === "AMZN" ? 0.01 : 0.005
            if (Math.random() < eventLikelihood) { // 0.5% chance of major event
                data.eventType = Math.random() < 0.5 ? 'crash' : 'boom';
                data.eventDuration = Math.floor(Math.random() * 20) + 10; // 10-30 ticks
                data.eventStrength = (Math.random() * 0.5) + 0.5; // 0.5-1.0 strength
            }


            const baseVolatility = stock === 'BITCOIN' ? 0.13 : 0.04;
            if (!data.momentum) data.momentum = 0;
            data.momentum *= 0.95; // Decay previous momentum
            data.momentum += (Math.random() - 0.5) * 0.1; // Add new momentum
            data.momentum = Math.max(Math.min(data.momentum, 1), -1); // Clamp momentum
                

            let changePercent = (Math.random() - 0.5 + data.momentum) * baseVolatility;
            if (data.eventType && data.eventDuration > 0) {
                if (data.eventType === 'crash') {
                    changePercent -= data.eventStrength * 0.1;
                } else { // boom
                    changePercent += data.eventStrength * 0.1;
                }
                data.eventDuration--;
                if (data.eventDuration <= 0) {
                    data.eventType = null;
                }
            }
            
            const meanReversionFactor = stock === 'AAPL' ? 0.05 : stock === "GOOGL" ? 0.01 : 0; // Adjust this factor to control mean reversion strength
            const meanPrice = data.startPrice;
            const newPrice = data.currentPrice * (1 + changePercent) + meanReversionFactor * (meanPrice - data.currentPrice);
            data.currentPrice = Math.max(newPrice, 1);
            
            stockData[stock].history.push(newPrice);
            if (stockData[stock].history.length > 50) {
                stockData[stock].history.shift();
            }

            // Update price display
            const priceDisplay = document.getElementById('currentPrice');
            const isPositive = newPrice >= stockData[stock].startPrice;
            priceDisplay.style.color = isPositive ? '#00ff00' : '#ff0000';
            priceDisplay.textContent = `$${newPrice.toFixed(2)}`;

            // change favicon in head from icons/up/favicon.ico to icons/down/favicon.ico
            const favicons = document.querySelectorAll('link[rel="icon"]');
            const appleIcon = document.querySelector('link[rel="apple-touch-icon"]');
            const androidIcons = document.querySelectorAll('link[rel="android-chrome-icon"]');
            
            const direction = isPositive ? 'up' : 'down';
            favicons.forEach(icon => {
                const currentPath = icon.getAttribute('href');
                icon.href = currentPath.replace(/\/(up|down)\//, `/${direction}/`);
            });
            
            appleIcon.href = `/icons/${direction}/apple-touch-icon.png`;
            
            androidIcons.forEach(icon => {
                const currentPath = icon.getAttribute('href');
                icon.href = currentPath.replace(/\/(up|down)\//, `/${direction}/`);
            });
            
            updatePortfolio();
        }

        function updateChart(stock) {
            const ctx = document.getElementById('stockChart').getContext('2d');
            const data = stockData[stock];
            const isPositive = data.history[data.history.length - 1] >= data.history[0];

            if (!chart) {
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array(data.history.length).fill(''),
                        datasets: [{
                            label: stock,
                            data: data.history,
                            borderColor: isPositive ? '#00ff00' : '#ff0000',
                            borderWidth: 2,
                            fill: isPositive ? true : 'origin',
                            backgroundColor: createGradient(ctx, isPositive),
                            tension: 0.4,
                            pointRadius: 0 
                        },
                        {
                            label: 'Starting Price',
                            data: Array(data.history.length).fill(data.startPrice),
                            borderColor: '#666',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: {
                                    color: '#333'
                                },
                                ticks: {
                                    display: false
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        animation: {
                            duration: 0,
                        }
                    }
                });
            } else {
                chart.data.datasets[0].data = data.history;
                chart.data.datasets[0].borderColor = isPositive ? '#00ff00' : '#ff0000';
                chart.data.datasets[0].fill = isPositive ? true : 'origin';
                chart.data.datasets[0].backgroundColor = createGradient(ctx, isPositive);
                chart.data.datasets[1].data = Array(data.history.length).fill(data.startPrice);
                const recentHistory = data.history.slice(-50);
                chart.options.scales.y.min = Math.min(...recentHistory, data.startPrice);
                chart.options.scales.y.max = Math.max(...recentHistory, data.startPrice);
                chart.update();
            }
        }

        document.getElementById('stockSelect').addEventListener('change', (e) => {
            currentStock = e.target.value;
            if (chart) {
                chart.destroy();
                chart = null;
            }
            updateChart(currentStock);
            updatePortfolio();
        });

        document.getElementById('buyButton').addEventListener('click', () => {
            const data = stockData[currentStock];
            if (cashBalance >= data.currentPrice) {
                data.shares++;
                data.totalCost += data.currentPrice;
                cashBalance -= data.currentPrice;
                updatePortfolio();
                updateCashPosition();
            }
        });

        document.getElementById('sellButton').addEventListener('click', () => {
            const data = stockData[currentStock];
            if (data.shares > 0) {
                if (!leverageUnlocked) {
                    leverageUnlocked = true;
                    document.getElementById('leverageButton').style.display = 'inline-block';
                    document.getElementById('leverageDisplay').style.display = 'inline-block';
                    showLeveragePopup();
                }
                data.shares--;
                const sellValue = data.currentPrice + ((data.currentPrice - (data.totalCost / (data.shares + 1))) * (leverage - 1));
                cashBalance += sellValue;
                data.totalCost = (data.shares * data.totalCost) / (data.shares + 1); // Adjust cost basis
                updatePortfolio();
                updateCashPosition();
                checkForMarginCall();  
            }
        });

        document.getElementById('leverageButton').addEventListener('click', () => {
            leverage = leverage === 8 ? 1 : leverage * 2;
            document.getElementById('leverageDisplay').textContent = leverage + 'x';
            updatePortfolio();
        });
        // Add this new function
        function showLeveragePopup() {
            // const sound = new Audio('/sounds/leverage.wav');
            // sound.volume = 0.5; // Adjust volume to 50%
            // sound.play().catch(e => console.log('Sound play failed:', e)); // Catch errors if sound fails to play

            const popup = document.createElement('div');
            popup.innerHTML = 'LEVERAGE ENABLED';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: rgba(255, 193, 7, 0.9);
                color: black;
                padding: 20px 40px;
                border-radius: 8px;
                font-size: 24px;
                font-weight: bold;
                animation: popupFade 2s forwards, textFlash 0.5s linear infinite;
                z-index: 1000;
            `;

            // Add the animation style to head
            const style = document.createElement('style');
            style.textContent = `
                @keyframes popupFade {
                    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.7); }
                    10% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
                    20% { transform: translate(-50%, -50%) scale(1); }
                    80% { opacity: 1; }
                    100% { opacity: 0; }
                }
                @keyframes textFlash {
                    0% { color: black; }
                    50% { color: white; }
                    100% { color: black; }
                }

                @media screen and (max-width: 768px) {
                    .popup {
                        font-size: 18px;
                        padding: 15px 30px;
                    }
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(popup);

            // Remove popup after animation
            setTimeout(() => {
                popup.remove();
                style.remove();
            }, 2000);
        }

        // Update prices and chart every 100ms for smoother animation
        setInterval(() => {
            updatePrice(currentStock);
            updateChart(currentStock);
        }, 100);

        // Initial setup
        updateChart('AAPL');
        updateCashPosition();
        updateButtonStates();
    </script>
</body>
</html>
